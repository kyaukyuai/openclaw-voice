const {
  formatClockLabel,
  formatSessionUpdatedAt,
  getHistoryDayKey,
  getHistoryDayLabel,
} = require('./app-runtime-pure.js');

function buildAppContentWiringInput(input) {
  const {
    settings,
    gateway,
    theme,
    appState,
    gatewayRuntimeController,
    composerRuntime,
    settingsUiRuntime,
    uiFlags,
    runtimeWiring,
  } = input;

  return {
    homeUiStateInput: {
      transcript: appState.transcript,
      interimTranscript: appState.interimTranscript,
      isRecognizing: appState.isRecognizing,
      quickTextLeft: settings.quickTextLeft,
      quickTextRight: settings.quickTextRight,
      focusedField: appState.focusedField,
      shouldShowSettingsScreen: uiFlags.shouldShowSettingsScreen,
      isKeyboardVisible: composerRuntime.isKeyboardVisible,
      isSending: gatewayRuntimeController.state.isSending,
      settingsReady: settings.isReady,
      isSessionOperationPending: appState.isSessionOperationPending,
      isGatewayConnected: uiFlags.isGatewayConnected,
      isSessionsLoading: gateway.isSessionsLoading,
      sessions: appState.sessions,
      sessionPreferences: appState.sessionPreferences,
      sessionsError: appState.sessionsError,
      isSettingsSaving: settings.isSaving,
      settingsPendingSaveCount: settings.pendingSaveCount,
      settingsSaveError: settings.saveError,
      settingsLastSavedAt: settings.lastSavedAt,
      isDarkTheme: theme.isDark,
      isOnboardingCompleted: settings.isOnboardingCompleted,
      gatewayUrl: settings.gatewayUrl,
      chatTurns: appState.chatTurns,
      isGatewayConnecting: uiFlags.isGatewayConnecting,
      isOnboardingWaitingForResponse: appState.isOnboardingWaitingForResponse,
      gatewayConnectDiagnostic: gateway.connectDiagnostic,
      outboxQueueLength: appState.outboxQueue.length,
      missingResponseNotice: appState.missingResponseNotice,
      activeSessionKey: appState.activeSessionKey,
      isMissingResponseRecoveryInFlight:
        gatewayRuntimeController.state.isMissingResponseRecoveryInFlight,
      historyRefreshNotice: appState.historyRefreshNotice,
      historyLastSyncedAt: appState.historyLastSyncedAt,
      historyBottomInset: composerRuntime.historyBottomInset,
      showScrollToBottomButton: appState.showScrollToBottomButton,
      gatewayError: appState.gatewayError,
      speechError: appState.speechError,
      gatewayEventState: gatewayRuntimeController.state.gatewayEventState,
      connectionState: gateway.connectionState,
      isStartupAutoConnecting: appState.isStartupAutoConnecting,
      isBottomCompletePulse: appState.isBottomCompletePulse,
      isKeyboardBarMounted: appState.isKeyboardBarMounted,
      formatClockLabel,
      getHistoryDayKey,
      getHistoryDayLabel,
      quickTextTooltipSide: appState.quickTextTooltipSide,
    },
    runtimeActions: {
      connectGateway: runtimeWiring.runtimeForContent.connectGateway,
      sendToGateway: runtimeWiring.runtimeForContent.sendToGateway,
      refreshSessions: runtimeWiring.runtimeForContent.refreshSessions,
      scheduleMissingResponseRecovery:
        runtimeWiring.runtimeForContent.scheduleMissingResponseRecovery,
      startRecognition: runtimeWiring.runtimeForContent.startRecognition,
      stopRecognition: runtimeWiring.runtimeForContent.stopRecognition,
    },
    gatewayActionHandlersHomeUiBaseInput: {
      setFocusedField: appState.setFocusedField,
      isMissingResponseRecoveryInFlight:
        gatewayRuntimeController.state.isMissingResponseRecoveryInFlight,
      isGatewayConnected: uiFlags.isGatewayConnected,
      setGatewayError: appState.setGatewayError,
      setMissingResponseNotice: appState.setMissingResponseNotice,
      setHistoryRefreshNotice: appState.setHistoryRefreshNotice,
      setSpeechError: appState.setSpeechError,
      setIsOnboardingWaitingForResponse: appState.setIsOnboardingWaitingForResponse,
      setIsOnboardingCompleted: settings.setOnboardingCompleted,
      forceMaskAuthToken: runtimeWiring.runtimeUiHelpers.forceMaskAuthToken,
      isSessionPanelOpen: appState.isSessionPanelOpen,
      setIsSettingsPanelOpen: appState.setIsSettingsPanelOpen,
      setIsSessionPanelOpen: appState.setIsSessionPanelOpen,
      setIsSessionRenameOpen: appState.setIsSessionRenameOpen,
      setSessionRenameTargetKey: appState.setSessionRenameTargetKey,
      setSessionRenameDraft: appState.setSessionRenameDraft,
      canToggleSettingsPanel: uiFlags.canToggleSettingsPanel,
      canDismissSettingsScreen: uiFlags.canDismissSettingsScreen,
      transcript: appState.transcript,
      interimTranscript: appState.interimTranscript,
      setTranscript: appState.setTranscript,
      setInterimTranscript: appState.setInterimTranscript,
      isSessionHistoryLoading: gatewayRuntimeController.state.isSessionHistoryLoading,
      clearHistoryNoticeTimer: runtimeWiring.runtimeUiHelpers.clearHistoryNoticeTimer,
      activeSessionKeyRef: appState.activeSessionKeyRef,
      loadSessionHistory: runtimeWiring.runtimeForContent.loadSessionHistory,
      setHistoryLastSyncedAt: appState.setHistoryLastSyncedAt,
      showHistoryRefreshNotice: runtimeWiring.runtimeUiHelpers.showHistoryRefreshNotice,
      formatClockLabel,
      scrollHistoryToBottom: runtimeWiring.runtimeUiHelpers.scrollHistoryToBottom,
      historyAutoScrollRef: appState.historyAutoScrollRef,
      setShowScrollToBottomButton: appState.setShowScrollToBottomButton,
      chatTurnsLength: appState.chatTurns.length,
      isRecognizing: appState.isRecognizing,
      isSending: gatewayRuntimeController.state.isSending,
      holdActivatedRef: appState.holdActivatedRef,
      holdStartTimerRef: appState.holdStartTimerRef,
      composerHeight: composerRuntime.composerHeight,
      setComposerHeight: composerRuntime.setComposerHeight,
    },
    gatewayActionHandlersInput: {
      quickTextInput: {
        isRecognizing: appState.isRecognizing,
        setTranscript: appState.setTranscript,
        setInterimTranscript: appState.setInterimTranscript,
        setQuickTextTooltipSide: appState.setQuickTextTooltipSide,
        clearQuickTextLongPressResetTimer:
          settingsUiRuntime.clearQuickTextLongPressResetTimer,
        scheduleQuickTextTooltipHide: settingsUiRuntime.scheduleQuickTextTooltipHide,
        hideQuickTextTooltip: settingsUiRuntime.hideQuickTextTooltip,
        quickTextLongPressSideRef: settingsUiRuntime.quickTextLongPressSideRef,
        quickTextLongPressResetTimerRef:
          settingsUiRuntime.quickTextLongPressResetTimerRef,
      },
      transcriptRef: appState.transcriptRef,
      interimTranscriptRef: appState.interimTranscriptRef,
      setTranscript: appState.setTranscript,
      setInterimTranscript: appState.setInterimTranscript,
      setSpeechError: appState.setSpeechError,
    },
  };
}

function buildKeyboardUiRuntimeInput(input) {
  return {
    showKeyboardActionBar: input.appContent.showKeyboardActionBar,
    setKeyboardState: input.composerRuntime.setKeyboardState,
    setIsKeyboardBarMounted: input.appState.setIsKeyboardBarMounted,
  };
}

function buildAppViewModelWiringInput(input) {
  const {
    settings,
    gateway,
    theme,
    appState,
    gatewayRuntimeController,
    composerRuntime,
    settingsUiRuntime,
    uiFlags,
    runtimeWiring,
    appContent,
    keyboardBarAnim,
  } = input;

  return {
    appContent,
    runtimeActions: {
      connectGateway: runtimeWiring.runtimeForViewModel.connectGateway,
      refreshSessions: runtimeWiring.runtimeForViewModel.refreshSessions,
      createAndSwitchSession:
        runtimeWiring.runtimeForViewModel.createAndSwitchSession,
      switchSession: runtimeWiring.runtimeForViewModel.switchSession,
      isSessionPinned: runtimeWiring.runtimeForViewModel.isSessionPinned,
      getSessionTitle: runtimeWiring.runtimeForViewModel.getSessionTitle,
      startSessionRename: runtimeWiring.runtimeForViewModel.startSessionRename,
      toggleSessionPinned: runtimeWiring.runtimeForViewModel.toggleSessionPinned,
      submitSessionRename: runtimeWiring.runtimeForViewModel.submitSessionRename,
    },
    keyboardBarAnim,
    ui: {
      isDarkTheme: theme.isDark,
      isGatewayConnected: uiFlags.isGatewayConnected,
      isGatewayConnecting: uiFlags.isGatewayConnecting,
      isSessionPanelOpen: appState.isSessionPanelOpen,
      isSettingsPanelOpen: appState.isSettingsPanelOpen,
      canToggleSettingsPanel: uiFlags.canToggleSettingsPanel,
      shouldShowSettingsScreen: uiFlags.shouldShowSettingsScreen,
      canDismissSettingsScreen: uiFlags.canDismissSettingsScreen,
      isKeyboardVisible: composerRuntime.isKeyboardVisible,
      isRecognizing: appState.isRecognizing,
      isSending: gatewayRuntimeController.state.isSending,
      isSessionHistoryLoading: gatewayRuntimeController.state.isSessionHistoryLoading,
      isMissingResponseRecoveryInFlight:
        gatewayRuntimeController.state.isMissingResponseRecoveryInFlight,
      isKeyboardBarMounted: appState.isKeyboardBarMounted,
      showScrollToBottomButton: appState.showScrollToBottomButton,
      isOnboardingWaitingForResponse: appState.isOnboardingWaitingForResponse,
      transcript: appState.transcript,
      interimTranscript: appState.interimTranscript,
      historyScrollRef: appState.historyScrollRef,
      isSessionsLoading: gateway.isSessionsLoading,
      settingsScrollRef: settingsUiRuntime.settingsScrollRef,
      focusedField: appState.focusedField,
      setFocusedField: appState.setFocusedField,
      gatewayUrl: settings.gatewayUrl,
      setGatewayUrl: settings.setGatewayUrl,
      authToken: settings.authToken,
      setAuthToken: settings.setAuthToken,
      isAuthTokenMasked: appState.isAuthTokenMasked,
      toggleAuthTokenVisibility:
        runtimeWiring.runtimeUiHelpers.toggleAuthTokenVisibility,
      settingsReady: settings.isReady,
      isStartupAutoConnecting: appState.isStartupAutoConnecting,
      gatewayDiagnosticIconName: appContent.gatewayDiagnosticIconName,
      gatewayConnectDiagnostic: gateway.connectDiagnostic,
      theme: theme.theme,
      setTheme: theme.setTheme,
      speechLang: settings.speechLang,
      setSpeechLang: settings.setSpeechLang,
      quickTextInputRefs: settingsUiRuntime.quickTextInputRefs,
      quickTextLeft: settings.quickTextLeft,
      setQuickTextLeft: settings.setQuickTextLeft,
      quickTextRight: settings.quickTextRight,
      setQuickTextRight: settings.setQuickTextRight,
      quickTextLeftIcon: settings.quickTextLeftIcon,
      setQuickTextLeftIcon: settings.setQuickTextLeftIcon,
      quickTextRightIcon: settings.quickTextRightIcon,
      setQuickTextRightIcon: settings.setQuickTextRightIcon,
      ensureSettingsFieldVisible: settingsUiRuntime.ensureSettingsFieldVisible,
      connectionState: gateway.connectionState,
      gatewayEventState: gatewayRuntimeController.state.gatewayEventState,
      activeSessionKey: appState.activeSessionKey,
      activeRunId: appState.activeRunId,
      historyLastSyncedAt: appState.historyLastSyncedAt,
      startupAutoConnectAttempt: appState.startupAutoConnectAttemptRef.current,
      sessionRenameTargetKey: appState.sessionRenameTargetKey,
      isSessionRenameOpen: appState.isSessionRenameOpen,
      sessionRenameDraft: appState.sessionRenameDraft,
      setSessionRenameDraft: appState.setSessionRenameDraft,
      isSessionOperationPending: appState.isSessionOperationPending,
      sessionsError: appState.sessionsError,
      formatSessionUpdatedAt,
      setIsSessionRenameOpen: appState.setIsSessionRenameOpen,
      setSessionRenameTargetKey: appState.setSessionRenameTargetKey,
    },
  };
}

module.exports = {
  buildAppContentWiringInput,
  buildKeyboardUiRuntimeInput,
  buildAppViewModelWiringInput,
};
